<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>MCI Kids - Minist√©rio Infantil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primaria:#4B1E6D; --secundaria:#FF9800; --azul:#4FC3F7; --verde:#8BC34A;
      --fundo:#FFF8E1; --card:#FCE4EC; --texto:#333; --borda:#ddd;
    }
    *{box-sizing:border-box}
    body{font-family:'Comic Neue',cursive;margin:0;background:var(--fundo);color:var(--texto);font-size:17px}
    header{background:var(--primaria);color:#fff;padding:16px;text-align:center}
    header img{height:90px}
    main{max-width:1000px;margin:0 auto;padding:16px}
    .versiculo{font-style:italic;color:var(--verde);text-align:center;margin:12px 0 20px}
    .menu-grid{display:grid;gap:12px;grid-template-columns:1fr;margin-top:12px}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.menu-grid{grid-template-columns:repeat(4,1fr)}}
    .btn{background:var(--secundaria);color:#fff;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-size:16px}
    .btn:hover{background:#F57C00}
    .btn-sec{background:var(--azul)}
    .btn-danger{background:#e53935}
    .btn-ghost{background:transparent;color:var(--primaria);border:1px solid var(--primaria)}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-top:16px;border:1px solid var(--borda)}
    .hidden{display:none!important}
    input,select,textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:8px;font-size:16px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #bbb;padding:8px;text-align:center;font-size:15px}
    th{background:#f5f5f5}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;font-size:12px}
    .subtle{color:#666;font-size:13px}
    .center{text-align:center}
    .mt-8{margin-top:8px} .mt-12{margin-top:12px} .mt-16{margin-top:16px}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label strong{margin-right:8px}
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo MCI Kids">
  <h1>Minist√©rio Infantil - MCI Kids</h1>
</header>
<main>
  <p class="versiculo">"Ensina a crian√ßa no caminho em que deve andar..." - Prov√©rbios 22:6</p>
  <div class="center"><button class="btn" onclick="mostrarMenu()">Entrar</button></div>

  <!-- Menu principal -->
  <div id="menuPrincipal" class="menu-grid hidden">
    <button class="btn" onclick="abrirArea('pais')">üë®‚Äçüë©‚Äçüëß Pais</button>
    <button class="btn" onclick="abrirArea('lider')">üôã‚Äç‚ôÇÔ∏è L√≠der</button>
    <button class="btn" onclick="abrirArea('auxiliar')">üßë‚Äçüè´ Auxiliar</button>
    <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
    <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
  </div>

  <!-- √Årea dos Pais -->
  <section id="area-pais" class="card hidden">
    <h2>√Årea dos Pais</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Temas do m√™s</h3>
        <ul id="temasPais"></ul>
        <h3>Eventos</h3>
        <ul id="eventosPais"></ul>
      </div>
      <div style="flex:1 1 320px">
        <h3>Ficha cadastral</h3>
        <input id="ficha-nome" placeholder="Nome da crian√ßa">
        <input id="ficha-nasc" type="date">
        <input id="ficha-resp" placeholder="Nome do respons√°vel">
        <input id="ficha-tel" placeholder="Telefone">
        <textarea id="ficha-obs" placeholder="Alergias/Observa√ß√µes"></textarea>
        <button class="btn" onclick="salvarFicha()">Salvar ficha</button>
        <ul id="fichas-lista" class="mt-12"></ul>
      </div>
    </div>
    <p class="subtle">Ficha manual; depois podemos gerar PDF ou salvar na nuvem.</p>
  </section>

  <!-- √Årea do L√≠der -->
  <section id="area-lider" class="card hidden">
    <h2>L√≠der</h2>
    <div id="lider-login">
      <input id="lider-email" type="email" placeholder="Email">
      <input id="lider-senha" type="password" placeholder="Senha">
      <button class="btn" onclick="login('lider')">Entrar</button>
      <p id="lider-erro" class="subtle"></p>
    </div>
    <div id="lider-painel" class="hidden">
      <p><span class="pill">L√≠der</span> Acesso completo.</p>
      <div class="flex">
        <button class="btn" onclick="abrirArea('presenca')">‚úÖ Presen√ßa</button>
        <button class="btn" onclick="abrirArea('arquivos')">üìÅ Arquivos</button>
        <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
        <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
      </div>
      <div id="lider-fichas" class="mt-16">
        <h3>Fichas recebidas dos Pais</h3>
        <ul id="fichas-lider"></ul>
      </div>
    </div>
  </section>

  <!-- √Årea do Auxiliar -->
  <section id="area-auxiliar" class="card hidden">
    <h2>Auxiliar</h2>
    <div id="auxiliar-entrada">
      <input id="aux-nome" placeholder="Seu nome">
      <button class="btn" onclick="entrarAuxiliar()">Entrar</button>
      <p id="aux-erro" class="subtle"></p>
    </div>
    <div id="auxiliar-painel" class="hidden">
      <p><span class="pill">Auxiliar</span> Permiss√µes limitadas.</p>
      <div class="flex">
        <button class="btn" onclick="abrirArea('presenca')">‚úÖ Presen√ßa</button>
        <button class="btn" onclick="abrirArea('arquivos')">üìÅ Arquivos</button>
        <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
        <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
        <button class="btn btn-danger" onclick="sairAuxiliar()">Sair</button>
      </div>
    </div>
  </section>

  <!-- Presen√ßa -->
  <section id="area-presenca" class="card hidden">
    <h2>Lista de Presen√ßa</h2>

    <!-- Data da chamada -->
    <div class="flex mt-8">
      <label for="dia-chamada"><strong>Dia da chamada:</strong></label>
      <input id="dia-chamada" type="date" />
      <button class="btn" onclick="renderPresenca()">Atualizar lista</button>
    </div>

    <!-- Controles de cadastro de pessoas -->
    <div id="aluno-controles" class="flex mt-8">
      <input id="novo-nome" placeholder="Nome do aluno/convidado">
      <select id="novo-tipo"><option value="aluno">Aluno</option><option value="convidado">Convidado</option></select>
      <button class="btn" onclick="adicionarPessoa()">Adicionar</button>
    </div>

    <!-- Tabela planilha -->
    <table class="mt-8">
      <thead><tr><th>Nome</th><th>Dia</th><th>Presen√ßa</th><th>Tipo</th><th>Registrado por</th><th>A√ß√µes</th></tr></thead>
      <tbody id="lista-presenca"></tbody>
    </table>

    <!-- Resumo e exporta√ß√£o -->
    <div class="mt-12">
      <h3>Resumo</h3>
      <div id="filtros-presenca" class="flex">
        <div class="intervalo-pres">
          <label>In√≠cio</label><input type="date" class="pres-inicio">
          <label>Fim</label><input type="date" class="pres-fim">
        </div>
      </div>
      <div class="flex mt-8">
        <button class="btn" onclick="adicionarIntervalo('presenca')">Adicionar intervalo</button>
        <button class="btn btn-sec" onclick="exportarPresencas()">Exportar CSV</button>
      </div>
      <table>
        <thead><tr><th>Nome</th><th>% Frequ√™ncia</th><th>Presentes</th><th>Faltas</th></tr></thead>
        <tbody id="resumo-presenca"></tbody>
      </table>
    </div>
    <p class="subtle mt-8">Auxiliar edita/deleta dentro de 24h; l√≠der sempre.</p>
  </section>

  <!-- Arquivos -->
  <section id="area-arquivos" class="card hidden">
    <h2>Arquivos</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Enviar arquivo</h3>
        <input id="arq-titulo" placeholder="T√≠tulo">
        <select id="arq-tipo"><option value="pdf">PDF</option><option value="txt">TXT</option></select>
        <input id="arq-file" type="file" accept=".pdf,.txt">
        <div class="mt-8"><button class="btn" onclick="enviarArquivo()">Enviar</button></div>
        <p class="subtle mt-8">Links reais vir√£o do Storage quando conectarmos a nuvem.</p>
      </div>
      <div style="flex:1 1 320px">
        <h3>Lista</h3>
        <ul id="arquivos-lista"></ul>
      </div>
    </div>
  </section>

  <!-- Ofertas -->
  <section id="area-oferta" class="card hidden">
    <h2>Ofertas</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Adicionar valor</h3>
        <select id="of-cat"><option value="oferta">Oferta</option><option value="gasto">Gasto pessoal</option></select>
        <select id="of-tipo"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select>
        <input id="of-valor" type="number" min="0" step="0.01" placeholder="Valor">
        <input id="of-obs" placeholder="Observa√ß√£o (opcional)">
        <button class="btn" onclick="adicionarOferta()">Registrar</button>
        <p class="subtle">Auxiliar n√£o registra sa√≠da de oferta.</p>
      </div>
      <div style="flex:1 1 320px">
        <h3>Saldo atual (Oferta)</h3>
        <p><strong id="saldo-atual">R$ 0,00</strong></p>
        <p class="subtle">Saldo = entradas de oferta ‚àí sa√≠das de oferta.</p>
      </div>
    </div>
    <h3 class="mt-12">Hist√≥rico</h3>
    <table>
      <thead><tr><th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Registrado por</th><th>Obs</th><th>A√ß√µes</th></tr></thead>
      <tbody id="historico-oferta"></tbody>
    </table>
    <div class="mt-12">
      <h3>Exportar</h3>
      <div id="filtros-oferta" class="flex">
        <div class="intervalo-of">
          <label>In√≠cio</label><input type="date" class="of-inicio">
          <label>Fim</label><input type="date" class="of-fim">
        </div>
      </div>
      <div class="flex mt-8">
        <button class="btn" onclick="adicionarIntervalo('oferta')">Adicionar intervalo</button>
        <button class="btn btn-sec" onclick="exportarOfertas()">Exportar CSV</button>
      </div>
    </div>
  </section>

  <!-- Feed -->
  <section id="area-feed" class="card hidden">
    <h2>Feed</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Nova mensagem</h3>
        <textarea id="feed-texto" placeholder="Escreva uma mensagem..."></textarea>
        <label><input type="checkbox" id="feed-publico"> Tornar p√∫blico (eventos/avisos)</label>
        <input id="feed-mencoes" placeholder="Mencionar usu√°rios (separe por v√≠rgula)">
        <select id="feed-tipo"><option value="aviso">Aviso</option><option value="evento">Evento</option><option value="escala">Escala</option></select>
        <button class="btn" onclick="postarFeed()">Postar</button>
        <p class="subtle">Privado: s√≥ mencionados veem. L√≠der v√™ tudo.</p>
      </div>
      <div style="flex:1 1 320px">
        <h3>Feed do seu papel</h3>
        <ul id="feed-papel"></ul>
      </div>
      <div style="flex:1 1 320px">
        <h3>Feed p√∫blico</h3>
        <ul id="feed-publico-lista"></ul>
      </div>
    </div>
  </section>
</main>

<script>
  // ===========================
  // ESTADO GLOBAL
  // ===========================
  const estado = {
    usuario: null,             // { uid, nome, papel }
    papel: 'visitante',
    auxiliarNome: '',
    alunos: [],                // [{id,nome,tipo}]
    presencas: [],             // [{id,alunoId,dataISO,presente,registradoPorNome,papel,criadoEm}]
    ofertas: [],               // [{id,categoria,tipo,valor,obs,criadoEm,registradoPorNome,papel}]
    feed: [],                  // [{id,texto,publico,mencionados[],tipo,criadoEm,criadoPorNome,reacoes,comentarios[]}]
    arquivos: [],              // [{id,titulo,tipo,url,criadoEm}]
    fichas: []                 // [{id,nome,nasc,resp,tel,obs,criadoEm}]
  };

  // ===========================
  // NAVEGA√á√ÉO
  // ===========================
  function mostrarMenu(){ document.getElementById('menuPrincipal').classList.remove('hidden'); }
  function abrirArea(id){
    const ids=['pais','lider','auxiliar','oferta','feed','arquivos','presenca'];
    ids.forEach(a=>document.getElementById('area-'+a).classList.add('hidden'));
    document.getElementById('area-'+id).classList.remove('hidden');
    if(id==='presenca') {
      const inputDia = document.getElementById('dia-chamada');
      if (inputDia && !inputDia.value) inputDia.value = new Date().toISOString().slice(0,10);
      renderPresenca();
    }
    if(id==='oferta') renderOferta();
    if(id==='feed') renderFeed();
    if(id==='arquivos') renderArquivos();
    if(id==='pais') renderPais();
    if(id==='lider') renderFichasLider();
  }
  function setPapel(p){
    estado.papel=p;
    if(p==='lider'){
      document.getElementById('lider-login').classList.add('hidden');
      document.getElementById('lider-painel').classList.remove('hidden');
    } else if(p==='auxiliar'){
      document.getElementById('auxiliar-entrada').classList.add('hidden');
      document.getElementById('auxiliar-painel').classList.remove('hidden');
    }
  }

  // ===========================
  // LOGIN / AUXILIAR
  // ===========================
  async function login(papel){
    const email=document.getElementById(`${papel}-email`)?.value;
    const senha=document.getElementById(`${papel}-senha`)?.value;
    if(!email||!senha){ document.getElementById(`${papel}-erro`).textContent='Digite email e senha.'; return; }
    estado.usuario={ uid:'uid-'+papel, nome:'L√≠der', papel };
    setPapel(papel);
    alert('L√≠der logado com sucesso!');
  }
  function entrarAuxiliar(){
    const nomeInput=document.getElementById('aux-nome');
    const nome=(nomeInput.value||'').trim();
    if(!nome){ document.getElementById('aux-erro').textContent='Informe seu nome.'; nomeInput.focus(); return; }
    estado.usuario={ uid:'aux-'+Date.now(), nome, papel:'auxiliar' };
    estado.auxiliarNome=nome;
    setPapel('auxiliar');
    alert(`Auxiliar ${nome} entrou.`);
  }
  function sairAuxiliar(){
    estado.usuario=null; estado.papel='visitante'; estado.auxiliarNome='';
    document.getElementById('auxiliar-painel').classList.add('hidden');
    document.getElementById('auxiliar-entrada').classList.remove('hidden');
    alert('Voc√™ saiu como auxiliar.');
  }

  // ===========================
  // REGRAS DE EDI√á√ÉO
  // ===========================
  function dentro24h(iso){ return (new Date() - new Date(iso)) < 24*60*60*1000; }
  function podeEditarPresenca(reg){
    const p=estado.usuario?.papel;
    return p==='lider' || (p==='auxiliar' && dentro24h(reg.criadoEm));
  }
  function podeEditarOferta(item){
    const p=estado.usuario?.papel;
    return p==='lider' || (p==='auxiliar' && item.tipo==='entrada');
  }
  function podeEditarFeed(item){
    const p=estado.usuario?.papel;
    return p==='lider' || (item.criadoPorNome===estado.usuario?.nome && dentro24h(item.criadoEm));
  }

  // ===========================
  // PRESEN√áA
  // ===========================
  function adicionarPessoa(){
    const nome=document.getElementById('novo-nome').value.trim();
    const tipo=document.getElementById('novo-tipo').value;
    if(!nome) return alert('Informe o nome.');
    if(estado.papel==='lider'){
      // l√≠der pode criar aluno e convidado
    } else if(estado.papel==='auxiliar'){
      if(tipo!=='convidado') return alert('Auxiliares s√≥ podem adicionar convidados.');
    } else {
      return alert('Entre como l√≠der ou auxiliar para adicionar.');
    }
    const id='al-'+Date.now();
    estado.alunos.push({ id, nome, tipo });
    document.getElementById('novo-nome').value='';
    renderPresenca();
  }

  function registrarOuAtualizarPresenca(alunoId, dataISO, presente){
    const registrador=estado.usuario?.nome || 'Visitante';
    const papel=estado.usuario?.papel || 'visitante';
    const idx=estado.presencas.findIndex(p=>p.alunoId===alunoId && p.dataISO===dataISO);
    if(idx>=0){
      const reg=estado.presencas[idx];
      if(!podeEditarPresenca(reg)) return alert('Sem permiss√£o para editar este registro.');
      reg.presente=presente;
      reg.registradoPorNome=registrador;
      reg.papel=papel;
    } else {
      estado.presencas.push({
        id:'pr-'+Date.now(), alunoId, dataISO, presente,
        registradoPorNome:registrador, papel, criadoEm:new Date().toISOString()
      });
    }
  }

  function renderPresenca(){
    const tbody=document.getElementById('lista-presenca'); if(!tbody) return;
    tbody.innerHTML='';
    const inputDia=document.getElementById('dia-chamada');
    const diaISO=inputDia?.value || new Date().toISOString().slice(0,10);

    // Exibe controles s√≥ para l√≠der/auxiliar
    document.getElementById('aluno-controles').classList.toggle('hidden', !(estado.papel==='lider' || estado.papel==='auxiliar'));

    // Para cada aluno, mostra o status do dia e a√ß√µes
    estado.alunos.forEach(a=>{
      const reg=estado.presencas.find(p=>p.alunoId===a.id && p.dataISO===diaISO);
      const tr=document.createElement('tr');

      const status=reg ? (reg.presente?'Presente':'Falta') : '‚Äî';
      const registrado=reg ? `${reg.registradoPorNome} (${reg.papel})` : '‚Äî';

      tr.innerHTML=`<td>${a.nome}</td>
                    <td>${diaISO}</td>
                    <td>${status}</td>
                    <td>${a.tipo}</td>
                    <td>${registrado}</td>`;

      const tdAcoes=document.createElement('td');

      if(reg){
        const can=podeEditarPresenca(reg);
        const editBtn=document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='‚úèÔ∏è Editar'; editBtn.disabled=!can;
        editBtn.onclick=()=>editarPresenca(reg.id);

        const delBtn=document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.textContent='üóëÔ∏è Deletar'; delBtn.disabled=!can;
        delBtn.onclick=()=>deletarPresenca(reg.id);

        tdAcoes.appendChild(editBtn);
        tdAcoes.appendChild(delBtn);
      } else {
        const btnPres=document.createElement('button'); btnPres.className='btn btn-ghost'; btnPres.textContent='Marcar Presente';
        btnPres.onclick=()=>{ registrarOuAtualizarPresenca(a.id, diaISO, true); renderPresenca(); };

        const btnFalta=document.createElement('button'); btnFalta.className='btn btn-ghost'; btnFalta.textContent='Marcar Falta';
        btnFalta.onclick=()=>{ registrarOuAtualizarPresenca(a.id, diaISO, false); renderPresenca(); };

        tdAcoes.appendChild(btnPres);
        tdAcoes.appendChild(btnFalta);
      }

      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);
    });

    resumoFrequencia();
  }

  function editarPresenca(id){
    const r=estado.presencas.find(x=>x.id===id);
    if(!r || !podeEditarPresenca(r)) return alert('Voc√™ n√£o tem permiss√£o para editar.');
    const novoStatus = confirm('Marcar como PRESENTE? OK=Presente, Cancelar=Falta');
    r.presente = novoStatus;
    renderPresenca();
  }
  function deletarPresenca(id){
    const idx=estado.presencas.findIndex(x=>x.id===id);
    if(idx<0) return;
    if(!podeEditarPresenca(estado.presencas[idx])) return alert('Voc√™ n√£o tem permiss√£o para deletar.');
    estado.presencas.splice(idx,1);
    renderPresenca();
  }

  function adicionarIntervalo(tipo){
    const wrapId = tipo==='presenca' ? 'filtros-presenca' : 'filtros-oferta';
    const cls = tipo==='presenca' ? 'intervalo-pres' : 'intervalo-of';
    const wrap=document.getElementById(wrapId);
    const div=document.createElement('div');
    div.className=cls;
    div.innerHTML=`<label>In√≠cio</label><input type="date" class="${tipo==='presenca'?'pres-inicio':'of-inicio'}">
                   <label>Fim</label><input type="date" class="${tipo==='presenca'?'pres-fim':'of-fim'}">`;
    wrap.appendChild(div);
  }
  function resumoFrequencia(){
    const tbody=document.getElementById('resumo-presenca'); if(!tbody) return;
    tbody.innerHTML='';
    const datasSet=new Set(estado.presencas.map(p=>p.dataISO));
    const encontros=Array.from(datasSet);
    estado.alunos.forEach(a=>{
      const regs=estado.presencas.filter(p=>p.alunoId===a.id);
      const presentes=regs.filter(r=>r.presente).length;
      const faltas=regs.filter(r=>!r.presente).length;
      const total=encontros.length||1;
      const pct=Math.round((presentes/total)*100);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${a.nome}</td><td>${pct}%</td><td>${presentes}</td><td>${faltas}</td>`;
      tbody.appendChild(tr);
    });
  }
  function exportarPresencas(){
    const intervals=Array.from(document.querySelectorAll('#filtros-presenca .intervalo-pres')).map(div=>{
      const ini=div.querySelector('.pres-inicio').value;
      const fim=div.querySelector('.pres-fim').value;
      return {ini,fim};
    }).filter(x=>x.ini&&x.fim);
    const rows=estado.presencas.filter(p=>intervals.some(i=>p.dataISO>=i.ini && p.dataISO<=i.fim))
      .map(p=>{
        const aluno=estado.alunos.find(a=>a.id===p.alunoId)?.nome || '‚Äî';
        return [aluno, p.dataISO, p.presente?'Presente':'Falta', p.registradoPorNome, p.papel];
      });
    baixarCSV('presencas.csv', ['Nome','Data','Presen√ßa','Registrado Por','Papel'], rows);
  }

  // ===========================
  // OFERTAS
  // ===========================
  function canSaidaOferta(){ return estado.papel==='lider'; }
  function adicionarOferta(){
    if(!estado.usuario || !estado.usuario.nome) return alert('Entre como L√≠der ou Auxiliar para registrar.');
    const cat=document.getElementById('of-cat').value;
    const tipo=document.getElementById('of-tipo').value;
    const valor=parseFloat(document.getElementById('of-valor').value || '0');
    const obs=document.getElementById('of-obs').value.trim();
    if(!valor || valor<=0) return alert('Informe um valor v√°lido.');
    if(cat==='oferta' && tipo==='saida' && !canSaidaOferta()) return alert('Somente l√≠deres podem registrar sa√≠da de oferta.');
    const registrador=estado.usuario?.nome || 'Visitante';
    const papel=estado.usuario?.papel || 'visitante';
    const item={ id:'of-'+Date.now(), categoria:cat, tipo, valor, obs, criadoEm:new Date().toISOString(), registradoPorNome:registrador, papel };
    estado.ofertas.push(item);
    document.getElementById('of-valor').value=''; document.getElementById('of-obs').value='';
    renderOferta();
  }
  function renderOferta(){
    const entradasOferta=estado.ofertas.filter(o=>o.categoria==='oferta' && o.tipo==='entrada').reduce((s,o)=>s+o.valor,0);
    const saidasOferta=estado.ofertas.filter(o=>o.categoria==='oferta' && o.tipo==='saida').reduce((s,o)=>s+o.valor,0);
    const saldo=entradasOferta - saidasOferta;
    document.getElementById('saldo-atual').textContent='R$ ' + saldo.toFixed(2).replace('.', ',');
    const tbody=document.getElementById('historico-oferta'); tbody.innerHTML='';
    estado.ofertas.slice().reverse().forEach(o=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(o.criadoEm).toLocaleString()}</td>
                    <td>${o.categoria}</td>
                    <td>${o.tipo}</td>
                    <td>R$ ${o.valor.toFixed(2).replace('.', ',')}</td>
                    <td>${o.registradoPorNome} (${o.papel})</td>
                    <td>${o.obs || ''}</td>`;
      const tdAcoes=document.createElement('td');
      const can=podeEditarOferta(o);
      const editBtn=document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='‚úèÔ∏è Editar'; editBtn.disabled=!can;
      editBtn.onclick=()=>editarOferta(o.id);
      tdAcoes.appendChild(editBtn);
      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);
    });
  }
  function editarOferta(id){
    const item=estado.ofertas.find(o=>o.id===id);
    if(!item || !podeEditarOferta(item)) return alert('Voc√™ n√£o tem permiss√£o para editar.');
    const nv=prompt('Novo valor (use ponto para centavos):', item.valor);
    const val=parseFloat(nv);
    if(!isNaN(val) && val>0){ item.valor=val; renderOferta(); }
  }
  function exportarOfertas(){
    const intervals=Array.from(document.querySelectorAll('#filtros-oferta .intervalo-of')).map(div=>{
      const ini=div.querySelector('.of-inicio').value;
      const fim=div.querySelector('.of-fim').value;
      return {ini,fim};
    }).filter(x=>x.ini&&x.fim);
    const rows=estado.ofertas.filter(o=>{
      const d=o.criadoEm.slice(0,10);
      return intervals.some(i=>d>=i.ini && d<=i.fim);
    }).map(o=>[o.criadoEm, o.categoria, o.tipo, o.valor.toFixed(2).replace('.', ','), o.registradoPorNome, o.papel, o.obs||'']);
    baixarCSV('ofertas.csv', ['Data','Categoria','Tipo','Valor','Registrado Por','Papel','Obs'], rows);
  }

  // ===========================
  // FEED
  // ===========================
  function postarFeed(){
    const texto=document.getElementById('feed-texto').value.trim();
    const publico=document.getElementById('feed-publico').checked;
    const mencoes=document.getElementById('feed-mencoes').value.split(',').map(s=>s.trim()).filter(Boolean);
    const tipo=document.getElementById('feed-tipo').value;
    if(!texto) return alert('Digite uma mensagem.');
    const autor=estado.usuario?.nome || 'Visitante';
    const item={ id:'fd-'+Date.now(), texto, publico, mencionados:mencoes, tipo, criadoEm:new Date().toISOString(), criadoPorNome:autor, reacoes:{gostei:0, coracao:0, festa:0}, comentarios:[] };
    estado.feed.push(item);
    document.getElementById('feed-texto').value=''; document.getElementById('feed-mencoes').value='';
    renderFeed();
    alert('Mensagem postada.');
  }
  function renderFeed(){
    const ulPapel=document.getElementById('feed-papel');
    const ulPublico=document.getElementById('feed-publico-lista');
    ulPapel.innerHTML=''; ulPublico.innerHTML='';
    const nomeAtual=estado.usuario?.nome?.toLowerCase() || '';
    const papelAtual=estado.papel;
    const feedPapel=estado.feed.filter(item=>{
      if(papelAtual==='lider') return true;
      const mencionado=item.mencionados.map(m=>m.toLowerCase()).includes(nomeAtual);
      return item.publico || mencionado;
    }).slice().reverse();
    const feedPub=estado.feed.filter(f=>f.publico && f.tipo==='evento').slice().reverse();
    for(const item of feedPapel) ulPapel.appendChild(renderFeedItem(item, true));
    for(const item of feedPub) ulPublico.appendChild(renderFeedItem(item, false));
  }
  function renderFeedItem(item, podeComentar){
    const li=document.createElement('li'); li.className='card';
    const menc=item.mencionados?.length ? `<div class="subtle">Men√ß√µes: ${item.mencionados.join(', ')}</div>` : '';
    li.innerHTML=`<strong>${item.tipo.toUpperCase()}</strong> ‚Ä¢ ${new Date(item.criadoEm).toLocaleString()}<br>
                  <div>${item.texto}</div>
                  <div class="mt-8">
                    <button class="btn btn-ghost" onclick="reagir('${item.id}','gostei')">üëç ${item.reacoes.gostei}</button>
                    <button class="btn btn-ghost" onclick="reagir('${item.id}','coracao')">‚ù§Ô∏è ${item.reacoes.coracao}</button>
                    <button class="btn btn-ghost" onclick="reagir('${item.id}','festa')">üéâ ${item.reacoes.festa}</button>
                  </div>
                  ${menc}`;
    const canEdit=podeEditarFeed(item);
    const editBtn=document.createElement('button'); editBtn.className='btn btn-ghost mt-8'; editBtn.textContent='‚úèÔ∏è Editar';
    editBtn.disabled=!canEdit; editBtn.onclick=()=>editarFeed(item.id);
    li.appendChild(editBtn);
    if(podeComentar){
      const box=document.createElement('div'); box.className='mt-8';
      const input=document.createElement('input'); input.placeholder='Escreva um coment√°rio...';
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Comentar';
      btn.onclick=()=>comentar(item.id, input.value);
      box.appendChild(input); box.appendChild(btn);
      li.appendChild(box);
    }
    if(item.comentarios?.length){
      const ul=document.createElement('ul'); ul.className='mt-8';
      item.comentarios.forEach(c=>{
        const ci=document.createElement('li'); ci.innerHTML=`<span class="subtle">${c.nome}:</span> ${c.texto}`;
        ul.appendChild(ci);
      });
      li.appendChild(ul);
    }
    return li;
  }
  function reagir(id,tipo){
    const f=estado.feed.find(x=>x.id===id); if(!f) return;
    f.reacoes[tipo]=(f.reacoes[tipo]||0)+1; renderFeed();
  }
  function comentar(id,texto){
    const t=texto.trim(); if(!t) return alert('Escreva algo.');
    const f=estado.feed.find(x=>x.id===id); if(!f) return;
    const nome=estado.usuario?.nome || 'Visitante';
    f.comentarios.push({nome, texto:t, aprovado:true}); renderFeed();
  }
  function editarFeed(id){
    const item=estado.feed.find(f=>f.id===id);
    if(!item || !podeEditarFeed(item)) return alert('Voc√™ n√£o tem permiss√£o para editar.');
    const novo=prompt('Novo texto:', item.texto);
    if(novo) { item.texto=novo; renderFeed(); }
  }

  // ===========================
  // ARQUIVOS
  // ===========================
  function enviarArquivo(){
    if(!(estado.papel==='lider' || estado.papel==='auxiliar')) return alert('Entre como l√≠der ou auxiliar para enviar arquivos.');
    const titulo=document.getElementById('arq-titulo').value.trim();
    const tipo=document.getElementById('arq-tipo').value;
    const fileInput=document.getElementById('arq-file');
    if(!titulo || !fileInput.files.length) return alert('Informe t√≠tulo e selecione um arquivo.');
    const id='arq-'+Date.now();
    estado.arquivos.push({ id, titulo, tipo, url:fileInput.files[0].name, criadoEm:new Date().toISOString() });
    document.getElementById('arq-titulo').value=''; fileInput.value='';
    renderArquivos();
  }
  function renderArquivos(){
    const lista=document.getElementById('arquivos-lista'); lista.innerHTML='';
    estado.arquivos.slice().reverse().forEach(a=>{
      const li=document.createElement('li');
      const link = a.url ? `<a href="#" onclick="alert('Link real vir√° do Firebase Storage');return false;">üì• Baixar</a>` : '';
      li.innerHTML = `${a.titulo} (${a.tipo.toUpperCase()}) ‚Ä¢ <span class="subtle">${new Date(a.criadoEm).toLocaleString()}</span> ${link}`;
      lista.appendChild(li);
    });
  }

  // ===========================
  // PAIS: Fichas + render p√∫blico
  // ===========================
  function salvarFicha(){
    const nome=document.getElementById('ficha-nome').value.trim();
    const nasc=document.getElementById('ficha-nasc').value;
    const resp=document.getElementById('ficha-resp').value.trim();
    const tel=document.getElementById('ficha-tel').value.trim();
    const obs=document.getElementById('ficha-obs').value.trim();
    if(!nome || !nasc || !resp || !tel) return alert('Preencha todos os campos obrigat√≥rios.');
    estado.fichas.push({ id:'fi-'+Date.now(), nome, nasc, resp, tel, obs, criadoEm:new Date().toISOString() });
    document.getElementById('ficha-nome').value='';
    document.getElementById('ficha-nasc').value='';
    document.getElementById('ficha-resp').value='';
    document.getElementById('ficha-tel').value='';
    document.getElementById('ficha-obs').value='';
    renderPais();
    renderFichasLider();
    alert('Ficha salva!');
  }
  function renderPais(){
    const temas=document.getElementById('temasPais'); const eventos=document.getElementById('eventosPais');
    if(temas){ temas.innerHTML=''; ['Gratid√£o','Obedi√™ncia','Amor ao Pr√≥ximo'].forEach(t=>{ const li=document.createElement('li'); li.textContent=t; temas.appendChild(li); }); }
    if(eventos){
      eventos.innerHTML='';
      estado.feed.filter(f=>f.publico && f.tipo==='evento').slice().reverse().forEach(ev=>{
        const li=document.createElement('li'); li.textContent=`${ev.texto} ‚Ä¢ ${new Date(ev.criadoEm).toLocaleDateString()}`; eventos.appendChild(li);
      });
    }
    const fichasUL=document.getElementById('fichas-lista');
    if(fichasUL){
      fichasUL.innerHTML='';
      estado.fichas.slice().reverse().forEach(fi=>{
        const li=document.createElement('li');
        li.innerHTML=`${fi.nome} ‚Ä¢ nasc: ${fi.nasc} ‚Ä¢ resp: ${fi.resp} ‚Ä¢ tel: ${fi.tel} ‚Ä¢ <span class="subtle">${new Date(fi.criadoEm).toLocaleString()}</span>`;
        fichasUL.appendChild(li);
      });
    }
  }
  function renderFichasLider(){
    const ul=document.getElementById('fichas-lider');
    if(!ul) return;
    ul.innerHTML='';
    estado.fichas.slice().reverse().forEach(fi=>{
      const li=document.createElement('li');
      li.innerHTML=`${fi.nome} ‚Ä¢ nasc: ${fi.nasc} ‚Ä¢ resp: ${fi.resp} ‚Ä¢ tel: ${fi.tel} ‚Ä¢ <span class="subtle">${new Date(fi.criadoEm).toLocaleString()}</span>`;
      ul.appendChild(li);
    });
  }

  // ===========================
  // UTIL
  // ===========================
  function baixarCSV(nome, header, rows){
    const csv=[header.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=nome;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ===========================
  // INIT
  // ===========================
  (function init(){
    estado.papel='visitante';
  })();
</script>

<!--
Quando quiser, conectamos Firebase (Auth, Firestore, Storage) e substitu√≠mos os arrays locais por cole√ß√µes.
-->
</body>
</html>

