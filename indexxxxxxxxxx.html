<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>MCI Kids - Minist√©rio Infantil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primaria:#4B1E6D; --sec:#FF9800; --azul:#4FC3F7; --verde:#8BC34A;
      --card:#FCE4EC; --texto:#333; --borda:#ddd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Comic Neue',cursive;color:var(--texto);font-size:15px;
      background: linear-gradient(90deg,#ff6b6b,#feca57,#1dd1a1,#54a0ff,#5f27cd);
      background-size:400% 400%;animation:rainbow 8s linear infinite;
      -webkit-font-smoothing:antialiased;
    }
    @keyframes rainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    header{background:rgba(75,30,109,0.95);color:#fff;padding:14px 12px;text-align:center}
    header img{height:64px;vertical-align:middle}
    main{max-width:980px;margin:18px auto;padding:18px;background:rgba(255,255,255,0.94);border-radius:12px}
    .versiculo{font-style:italic;color:var(--verde);text-align:center;margin:10px 0 18px}
    .menu-grid{display:grid;gap:10px;grid-template-columns:1fr;margin-top:12px}
    @media(min-width:640px){.menu-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.menu-grid{grid-template-columns:repeat(4,1fr)}}
    .btn{background:var(--sec);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:15px}
    .btn:hover{opacity:0.95}
    .btn-sec{background:var(--azul)}
    .btn-danger{background:#e53935}
    .btn-ghost{background:transparent;color:var(--primaria);border:1px solid var(--primaria);padding:8px 10px;border-radius:8px}
    .card{background:var(--card);border-radius:12px;padding:14px;margin-top:14px;border:1px solid var(--borda)}
    .hidden{display:none!important}
    input,select,textarea{width:100%;padding:8px;margin:8px 0;border:1px solid #ccc;border-radius:8px;font-size:15px}
    textarea{min-height:80px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #bbb;padding:8px;text-align:center;font-size:14px}
    th{background:#f5f5f5}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;font-size:12px}
    .subtle{color:#666;font-size:13px}
    .center{text-align:center}
    .mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fechado{opacity:0.92;border:2px dashed #bbb}
    .lock-pill{display:inline-block;padding:4px 8px;border-radius:8px;background:#f0f0f0;color:#333;font-size:13px;margin-left:8px}
    ul{padding-left:18px}
    label.small{font-size:13px;color:#555}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo MCI Kids" />
  <h1>Minist√©rio Infantil - MCI Kids</h1>
</header>

<main>
  <p class="versiculo">"Ensina a crian√ßa no caminho em que deve andar..." - Prov√©rbios 22:6</p>

  <div class="center"><button class="btn" onclick="mostrarMenu()">Entrar</button></div>

  <div id="menuPrincipal" class="menu-grid hidden">
    <button class="btn" onclick="abrirArea('pais')">üë®‚Äçüë©‚Äçüëß Pais</button>
    <button class="btn" onclick="abrirArea('lider')">üôã‚Äç‚ôÇÔ∏è L√≠der</button>
    <button class="btn" onclick="abrirArea('auxiliar')">üßë‚Äçüè´ Auxiliar</button>
    <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
    <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
  </div>

  <!-- √Årea dos Pais (Eventos mantido; Temas removido) -->
  <section id="area-pais" class="card hidden">
    <h2>√Årea dos Pais</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Eventos</h3>
        <ul id="eventosPais"></ul>
      </div>

      <div style="flex:1 1 320px">
        <h3>Ficha cadastral</h3>
        <input id="ficha-nome" placeholder="Nome da crian√ßa">
        <input id="ficha-nasc" type="date" placeholder="dd/mm/aaaa">
        <input id="ficha-resp" placeholder="Nome do respons√°vel">
        <input id="ficha-tel" placeholder="Telefone">
        <input id="ficha-endereco" placeholder="Endere√ßo completo">
        <input id="ficha-tel-emergencia" placeholder="Telefone para emerg√™ncia">
        <input id="ficha-contato-emergencia" placeholder="Nome do contato de emerg√™ncia">
        <textarea id="ficha-obs" placeholder="Alergias/Observa√ß√µes"></textarea>
        <button class="btn" onclick="salvarFicha()">Salvar ficha</button>

        <h4 class="mt-12">Cadastros</h4>
        <ul id="fichas-lista"></ul>
      </div>
    </div>
    <p class="subtle">As fichas ficam vis√≠veis aqui para os pais e l√≠deres. Os campos de emerg√™ncia ajudam em situa√ß√µes r√°pidas.</p>
  </section>

  <!-- √Årea do L√≠der -->
  <section id="area-lider" class="card hidden">
    <h2>L√≠der</h2>
    <div id="lider-login">
      <input id="lider-email" type="email" placeholder="Email">
      <input id="lider-senha" type="password" placeholder="Senha">
      <button class="btn" onclick="login('lider')">Entrar</button>
      <p id="lider-erro" class="subtle"></p>
    </div>

    <div id="lider-painel" class="hidden">
      <p><span class="pill">L√≠der</span> Acesso completo.</p>
      <div class="flex">
        <button class="btn" onclick="abrirArea('presenca')">‚úÖ Presen√ßa</button>
        <button class="btn" onclick="abrirArea('arquivos')">üìÅ Arquivos</button>
        <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
        <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
        <button class="btn btn-ghost" onclick="sairLider()">Sair</button>
      </div>

      <div class="card mt-12">
        <h3>Resumo financeiro</h3>
        <div class="flex">
          <div style="flex:1 1 220px">
            <p><strong>Entradas (oferta):</strong> <span id="ld-total-entradas">R$ 0,00</span></p>
            <p><strong>Sa√≠das (oferta):</strong> <span id="ld-total-saidas">R$ 0,00</span></p>
          </div>
          <div style="flex:1 1 220px">
            <p><strong>Saldo do m√™s atual:</strong> <span id="ld-saldo-mes-atual">R$ 0,00</span></p>
            <p><strong>Saldo acumulado (fechados):</strong> <span id="ld-saldo-acumulado">R$ 0,00</span></p>
            <p class="subtle">Saldo acumulado s√≥ √© atualizado ao fechar o m√™s.</p>
            <p><strong>√öltima movimenta√ß√£o:</strong> <span id="ld-ultima-mov">‚Äî</span></p>
          </div>
        </div>

        <div class="mt-8">
          <label class="small"><input type="checkbox" id="ld-permitir-edicoes-pos-fech" onchange="togglePermitirEdicoes()"> Permitir edi√ß√µes p√≥s-fechamento</label>
          <span class="subtle">Quando desligado, auxiliares n√£o editam registros fechados; l√≠der sempre pode editar.</span>
        </div>
      </div>

      <div class="card mt-12">
        <h3>Fechar m√™s</h3>
        <div class="flex">
          <button class="btn btn-danger" onclick="liderFecharMes()">Fechar m√™s</button>
          <span class="subtle" id="ld-fechar-mes-info">√öltimo fechamento: ‚Äî</span>
        </div>
      </div>

      <div class="card mt-12">
        <h3>Resumo de presen√ßa</h3>
        <div class="flex">
          <div style="flex:1 1 260px">
            <p><strong>Encontros √∫nicos:</strong> <span id="ld-pres-encontros">0</span></p>
            <p><strong>Total de alunos:</strong> <span id="ld-pres-alunos">0</span></p>
            <p><strong>Total de convidados:</strong> <span id="ld-pres-convidados">0</span></p>
          </div>
          <div style="flex:2 1 420px">
            <table>
              <thead><tr><th>Nome</th><th>% Frequ√™ncia</th><th>Presentes</th><th>Faltas</th></tr></thead>
              <tbody id="ld-pres-resumo"></tbody>
            </table>
            <div class="mt-8">
              <button class="btn btn-danger" onclick="fecharListaPresenca()">Fechar lista de presen√ßa</button>
              <span id="ld-pres-fechado-ind" class="lock-pill">Lista aberta</span>
            </div>
          </div>
        </div>
      </div>

      <div id="lider-fichas" class="mt-12">
        <h3>Fichas dos pais</h3>
        <ul id="fichas-lider"></ul>
      </div>
    </div>
  </section>

  <!-- √Årea do Auxiliar -->
  <section id="area-auxiliar" class="card hidden">
    <h2>Auxiliar</h2>
    <div id="auxiliar-entrada">
      <input id="aux-nome" placeholder="Seu nome">
      <button class="btn" onclick="entrarAuxiliar()">Entrar</button>
      <p id="aux-erro" class="subtle"></p>
    </div>
    <div id="auxiliar-painel" class="hidden">
      <p><span class="pill">Auxiliar</span> Permiss√µes limitadas.</p>
      <div class="flex">
        <button class="btn" onclick="abrirArea('presenca')">‚úÖ Presen√ßa</button>
        <button class="btn" onclick="abrirArea('arquivos')">üìÅ Arquivos</button>
        <button class="btn btn-sec" onclick="abrirArea('feed')">üì∞ Feed</button>
        <button class="btn" onclick="abrirArea('oferta')">üí∞ Oferta</button>
        <button class="btn btn-danger" onclick="sairAuxiliar()">Sair</button>
      </div>
    </div>
  </section>

  <!-- Presen√ßa -->
  <section id="area-presenca" class="card hidden">
    <h2>Lista de Presen√ßa</h2>

    <div class="flex mt-8">
      <label for="dia-chamada"><strong>Dia da chamada:</strong></label>
      <input id="dia-chamada" type="date" />
      <button class="btn" onclick="renderPresenca()">Atualizar lista</button>
    </div>

    <div id="aluno-controles" class="flex mt-8">
      <input id="novo-nome" placeholder="Nome do aluno/convidado">
      <select id="novo-tipo"><option value="aluno">Aluno</option><option value="convidado">Convidado</option></select>
      <button class="btn" onclick="adicionarPessoa()">Adicionar</button>
    </div>

    <table id="presenca-table" class="mt-8">
      <thead><tr><th>Nome</th><th>Dia</th><th>Presen√ßa</th><th>Tipo</th><th>Registrado por</th><th>A√ß√µes</th></tr></thead>
      <tbody id="lista-presenca"></tbody>
    </table>

    <div class="mt-12">
      <h3>Resumo</h3>
      <div id="filtros-presenca" class="flex">
        <div class="intervalo-pres">
          <label>In√≠cio</label><input type="date" class="pres-inicio">
          <label>Fim</label><input type="date" class="pres-fim">
        </div>
      </div>
      <div class="flex mt-8">
        <button class="btn" onclick="adicionarIntervalo('presenca')">Adicionar intervalo</button>
        <button class="btn btn-sec" onclick="exportarPresencas()">Exportar CSV</button>
      </div>
      <table>
        <thead><tr><th>Nome</th><th>% Frequ√™ncia</th><th>Presentes</th><th>Faltas</th></tr></thead>
        <tbody id="resumo-presenca"></tbody>
      </table>
      <p class="subtle mt-8">Auxiliar edita/deleta dentro de 24h; l√≠der sempre. Ap√≥s fechamento, edi√ß√£o depende da configura√ß√£o do l√≠der.</p>
    </div>
  </section>

  <!-- Arquivos -->
  <section id="area-arquivos" class="card hidden">
    <h2>Arquivos</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Enviar arquivo</h3>
        <input id="arq-titulo" placeholder="T√≠tulo">
        <select id="arq-tipo"><option value="pdf">PDF</option><option value="txt">TXT</option></select>
        <input id="arq-file" type="file" accept=".pdf,.txt">
        <div class="mt-8"><button class="btn" onclick="enviarArquivo()">Enviar</button></div>
        <p class="subtle mt-8">Links reais vir√£o do Storage quando conectarmos a nuvem.</p>
      </div>
      <div style="flex:1 1 320px">
        <h3>Lista</h3>
        <ul id="arquivos-lista"></ul>
      </div>
    </div>
  </section>

  <!-- Ofertas -->
  <section id="area-oferta" class="card hidden">
    <h2>Ofertas</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Adicionar valor</h3>
        <select id="of-cat"><option value="oferta">Oferta</option><option value="gasto">Gasto pessoal</option></select>
        <select id="of-tipo"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select>
        <input id="of-valor" type="number" min="0" step="0.01" placeholder="Valor">
        <input id="of-obs" placeholder="Observa√ß√£o (opcional)">
        <button class="btn" onclick="adicionarOferta()">Registrar</button>
        <p class="subtle">Auxiliar n√£o registra sa√≠da de oferta.</p>
      </div>
      <div style="flex:1 1 320px">
        <h3>Saldo atual (Oferta)</h3>
        <p><strong id="saldo-atual">R$ 0,00</strong></p>
        <p class="subtle">Saldo = entradas de oferta ‚àí sa√≠das de oferta (m√™s atual).</p>

        <h3 class="mt-12">Saldo acumulado (fechados)</h3>
        <p><strong id="saldo-acumulado-oferta">R$ 0,00</strong></p>
        <p class="subtle">Somente soma de meses fechados; atualiza ap√≥s fechar o m√™s.</p>
      </div>
    </div>

    <h3 class="mt-12">Hist√≥rico</h3>
    <table>
      <thead><tr><th>Data</th><th>Categoria</th><th>Tipo</th><th>Valor</th><th>Registrado por</th><th>Obs</th><th>A√ß√µes</th></tr></thead>
      <tbody id="historico-oferta"></tbody>
    </table>

    <div class="mt-12">
      <h3>Exportar</h3>
      <div id="filtros-oferta" class="flex">
        <div class="intervalo-of">
          <label>In√≠cio</label><input type="date" class="of-inicio">
          <label>Fim</label><input type="date" class="of-fim">
        </div>
      </div>
      <div class="flex mt-8">
        <button class="btn" onclick="adicionarIntervalo('oferta')">Adicionar intervalo</button>
        <button class="btn btn-sec" onclick="exportarOfertas()">Exportar CSV</button>
      </div>
    </div>
  </section>

  <!-- Feed -->
  <section id="area-feed" class="card hidden">
    <h2>Feed</h2>
    <div class="flex">
      <div style="flex:1 1 320px">
        <h3>Nova mensagem</h3>
        <textarea id="feed-texto" placeholder="Escreva uma mensagem..."></textarea>
        <label class="small"><input type="checkbox" id="feed-publico"> Tornar p√∫blico (eventos/avisos)</label>
        <input id="feed-mencoes" placeholder="Mencionar usu√°rios (separe por v√≠rgula)">
        <select id="feed-tipo"><option value="aviso">Aviso</option><option value="evento">Evento</option><option value="escala">Escala</option></select>
        <button class="btn" onclick="postarFeed()">Postar</button>
        <p class="subtle">Privado at√© mencionar usu√°rios. Liberar √© tudo.</p>
      </div>

      <div style="flex:1 1 320px">
        <h3>Mensagens para voc√™</h3>
        <ul id="feed-papel"></ul>
      </div>

      <div style="flex:1 1 320px">
        <h3>Feed p√∫blico</h3>
        <ul id="feed-publico-lista"></ul>
      </div>
    </div>
  </section>

</main>

<script>
/* ===========================
   ESTADO INICIAL
   =========================== */
const estado = {
  usuario: null,
  papel: 'visitante',
  auxiliarNome: '',
  alunos: [
    // lista pr√©-carregada, ordenada alfabeticamente
    { id: 'al-Agatha', nome: 'Agatha', tipo: 'aluno' },
    { id: 'al-Alicya', nome: 'Alicya', tipo: 'aluno' },
    { id: 'al-AnaCecilia', nome: 'Ana Cecilia', tipo: 'aluno' },
    { id: 'al-AnaClara', nome: 'Ana Clara', tipo: 'aluno' },
    { id: 'al-AnaJulia', nome: 'Ana Julia', tipo: 'aluno' },
    { id: 'al-Arthur', nome: 'Arthur', tipo: 'aluno' },
    { id: 'al-BernardoTorres', nome: 'Bernardo Torres', tipo: 'aluno' },
    { id: 'al-CarlosMiguel', nome: 'Carlos Miguel', tipo: 'aluno' },
    { id: 'al-CarlosPeixinho', nome: 'Carlos Peixinho', tipo: 'aluno' },
    { id: 'al-CarlosVieira', nome: 'Carlos Vieira', tipo: 'aluno' },
    { id: 'al-DaviMenezes', nome: 'Davi Menezes', tipo: 'aluno' },
    { id: 'al-EmanuellePoco', nome: 'Emanuelle Po√ßo', tipo: 'aluno' },
    { id: 'al-ErickSantos', nome: 'Erick Santos', tipo: 'aluno' },
    { id: 'al-FelipeFerreira', nome: 'Felipe Ferreira', tipo: 'aluno' },
    { id: 'al-Gael', nome: 'Gael', tipo: 'aluno' },
    { id: 'al-HeitorAlves', nome: 'Heitor Alves', tipo: 'aluno' },
    { id: 'al-HeitorMorato', nome: 'Heitor Morato', tipo: 'aluno' },
    { id: 'al-Isaac', nome: 'Isaac', tipo: 'aluno' },
    { id: 'al-IsabellyMartins', nome: 'Isabelly Martins', tipo: 'aluno' },
    { id: 'al-JoaoMiguel', nome: 'Jo√£o Miguel', tipo: 'aluno' },
    { id: 'al-JoaoPedro', nome: 'Jo√£o Pedro', tipo: 'aluno' },
    { id: 'al-Julia', nome: 'J√∫lia', tipo: 'aluno' },
    { id: 'al-KauaBrito', nome: 'Kau√£ Brito', tipo: 'aluno' },
    { id: 'al-Laura', nome: 'Laura', tipo: 'aluno' },
    { id: 'al-Lavinia', nome: 'Lavinia', tipo: 'aluno' },
    { id: 'al-Leonardo', nome: 'Leonardo', tipo: 'aluno' },
    { id: 'al-LeornardoNascimento', nome: 'Leornardo Nascimento', tipo: 'aluno' },
    { id: 'al-Lorenzo', nome: 'Lorenzo', tipo: 'aluno' },
    { id: 'al-LuizMiguel', nome: 'Luiz Miguel', tipo: 'aluno' },
    { id: 'al-Melissa', nome: 'Melissa', tipo: 'aluno' },
    { id: 'al-Miguel', nome: 'Miguel', tipo: 'aluno' },
    { id: 'al-Pedro', nome: 'Pedro', tipo: 'aluno' },
    { id: 'al-Samuel', nome: 'Samuel', tipo: 'aluno' },
    { id: 'al-SophiaAssis', nome: 'Sophia Assis', tipo: 'aluno' },
    { id: 'al-SophiaBernades', nome: 'Sophia Bernades', tipo: 'aluno' },
    { id: 'al-SophiaRodrigues', nome: 'Sophia Rodrigues', tipo: 'aluno' },
    { id: 'al-TeoLima', nome: 'Teo Lima', tipo: 'aluno' },
    { id: 'al-TheoLuccaVieira', nome: 'Theo Lucca Vieira', tipo: 'aluno' },
    { id: 'al-Vinicius', nome: 'Vinicius', tipo: 'aluno' },
    { id: 'al-ViniciusAndrade', nome: 'Vinicius Andrade', tipo: 'aluno' },
    { id: 'al-VitorHugoGoncalves', nome: 'Vitor Hugo Gon√ßalves', tipo: 'aluno' },
    { id: 'al-Vitoria', nome: 'Vitoria', tipo: 'aluno' },
    { id: 'al-Yasmin', nome: 'Yasmin', tipo: 'aluno' }
  ],
  presencas: [],
  ofertas: [],
  feed: [],
  arquivos: [],
  fichas: [],
  saldoOfertaAcumulado: 0,
  ofertaUltimoFechamentoISO: null,
  presencaFechadaISO: null,
  permitirEdicoesPosFechamento: false
};

/* ===========================
   UI helpers
   =========================== */
function mostrarMenu(){ document.getElementById('menuPrincipal').classList.remove('hidden'); }
function abrirArea(id){
  const areas=['pais','lider','auxiliar','oferta','feed','arquivos','presenca'];
  areas.forEach(a=>{ const el=document.getElementById('area-'+a); if(el) el.classList.add('hidden'); });
  const target=document.getElementById('area-'+id); if(target) target.classList.remove('hidden');

  if(id==='presenca'){ const input=document.getElementById('dia-chamada'); if(input && !input.value) input.value = new Date().toISOString().slice(0,10); renderPresenca(); }
  if(id==='oferta') renderOferta();
  if(id==='feed') renderFeed();
  if(id==='arquivos') renderArquivos();
  if(id==='pais') renderPais();
  if(id==='lider'){ renderFichasLider(); renderPainelLider(); verificarFechamentoAutomatico(); }
}

function setPapel(p){ estado.papel=p; if(p==='lider'){ document.getElementById('lider-login').classList.add('hidden'); document.getElementById('lider-painel').classList.remove('hidden'); renderPainelLider(); } if(p==='auxiliar'){ document.getElementById('auxiliar-entrada').classList.add('hidden'); document.getElementById('auxiliar-painel').classList.remove('hidden'); } }

/* ===========================
   Autentica√ß√£o simples
   =========================== */
function login(papel){
  const email=document.getElementById(`${papel}-email`).value;
  const senha=document.getElementById(`${papel}-senha`).value;
  if(!email||!senha){ document.getElementById(`${papel}-erro`).textContent='Digite email e senha.'; return; }
  estado.usuario={ uid:'uid-'+papel, nome:'L√≠der', papel };
  setPapel(papel);
  alert('L√≠der logado com sucesso!');
}
function sairLider(){ estado.usuario=null; estado.papel='visitante'; document.getElementById('lider-painel').classList.add('hidden'); document.getElementById('lider-login').classList.remove('hidden'); alert('L√≠der deslogado.'); }
function entrarAuxiliar(){ const nome=document.getElementById('aux-nome').value.trim(); if(!nome){ document.getElementById('aux-erro').textContent='Informe seu nome.'; return; } estado.usuario={ uid:'aux-'+Date.now(), nome, papel:'auxiliar' }; estado.auxiliarNome=nome; setPapel('auxiliar'); alert(`Auxiliar ${nome} entrou.`); }
function sairAuxiliar(){ estado.usuario=null; estado.papel='visitante'; estado.auxiliarNome=''; document.getElementById('auxiliar-painel').classList.add('hidden'); document.getElementById('auxiliar-entrada').classList.remove('hidden'); alert('Voc√™ saiu como auxiliar.'); }

/* ===========================
   Utilit√°rios
   =========================== */
function moeda(n){ return 'R$ ' + Number(n).toFixed(2).replace('.', ','); }
function yyyymm(date){ const d=new Date(date); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function baixarCSV(nome, header, rows){ const csv=[header.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=nome; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function dentro24h(iso){ return (new Date() - new Date(iso)) < 24*60*60*1000; }

/* ===========================
   Permiss√µes
   =========================== */
function podeEditarPresenca(reg){
  const p = estado.usuario?.papel;
  if(p==='lider') return true;
  if(estado.presencaFechadaISO && !estado.permitirEdicoesPosFechamento) return false;
  return p==='auxiliar' && dentro24h(reg.criadoEm);
}
function podeEditarOferta(item){
  const p = estado.usuario?.papel;
  if(p==='lider') return true;
  if(estado.ofertaUltimoFechamentoISO && !estado.permitirEdicoesPosFechamento) return false;
  return p==='auxiliar' && item.tipo==='entrada';
}
function podeEditarFeed(item){
  const p = estado.usuario?.papel;
  return p==='lider' || (item.criadoPorNome===estado.usuario?.nome && dentro24h(item.criadoEm));
}

/* ===========================
   Presen√ßa (lista pr√©-carregada)
   =========================== */
function adicionarPessoa(){
  const nomeRaw = document.getElementById('novo-nome').value || '';
  const nome = nomeRaw.trim();
  const tipo = document.getElementById('novo-tipo').value;
  if(!nome) return alert('Informe o nome.');

  const existe = estado.alunos.find(a => a.nome.trim().toLowerCase() === nome.toLowerCase());
  if(existe){
    if(existe.tipo !== tipo){ existe.tipo = tipo; alert(`O nome "${nome}" j√° existe. Tipo atualizado para "${tipo}".`); document.getElementById('novo-nome').value=''; renderPresenca(); renderLiderPresencas(); renderLiderLog(); return; }
    alert(`O nome "${nome}" j√° est√° cadastrado.`); document.getElementById('novo-nome').value=''; return;
  }

  if(estado.papel==='auxiliar' && tipo!=='convidado') return alert('Auxiliares s√≥ podem adicionar convidados.');
  if(!['lider','auxiliar'].includes(estado.papel)) return alert('Entre como l√≠der ou auxiliar para adicionar.');

  const id='al-'+Date.now();
  estado.alunos.push({ id, nome, tipo });
  document.getElementById('novo-nome').value='';
  estado.alunos.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
  renderPresenca(); renderLiderPresencas(); renderLiderLog();
}

function registrarOuAtualizarPresenca(alunoId, dataISO, presente){
  if(estado.presencaFechadaISO && !estado.permitirEdicoesPosFechamento && estado.usuario?.papel !== 'lider'){
    return alert('Lista de presen√ßa est√° fechada. Pe√ßa ao l√≠der para permitir edi√ß√µes.');
  }

  const registrador = estado.usuario?.nome || 'Visitante';
  const papel = estado.usuario?.papel || 'visitante';
  const idx = estado.presencas.findIndex(p => p.alunoId===alunoId && p.dataISO===dataISO);
  if(idx >= 0){
    const reg = estado.presencas[idx];
    if(!podeEditarPresenca(reg)) return alert('Sem permiss√£o para editar este registro.');
    reg.presente = presente; reg.registradoPorNome = registrador; reg.papel = papel;
  } else {
    estado.presencas.push({ id:'pr-'+Date.now(), alunoId, dataISO, presente, registradoPorNome:registrador, papel, criadoEm:new Date().toISOString() });
  }
  renderLiderPresencas(); renderLiderLog(); renderPresenca();
}

function renderPresenca(){
  const tbody = document.getElementById('lista-presenca'); if(!tbody) return; tbody.innerHTML='';
  const diaISO = (document.getElementById('dia-chamada')?.value) || new Date().toISOString().slice(0,10);
  const controles = document.getElementById('aluno-controles'); if(controles) controles.classList.toggle('hidden', !(estado.papel==='lider' || estado.papel==='auxiliar'));

  estado.alunos.forEach(a=>{
    const reg = estado.presencas.find(p => p.alunoId===a.id && p.dataISO===diaISO);
    const tr = document.createElement('tr');
    const status = reg ? (reg.presente ? 'Presente' : 'Falta') : '‚Äî';
    const registrado = reg ? `${reg.registradoPorNome} (${reg.papel})` : '‚Äî';
    tr.innerHTML = `<td>${a.nome}</td><td>${diaISO}</td><td>${status}</td><td>${a.tipo}</td><td>${registrado}</td>`;
    const td = document.createElement('td');
    if(reg){
      const can = podeEditarPresenca(reg);
      const edit = document.createElement('button'); edit.className='btn btn-ghost'; edit.textContent='‚úèÔ∏è Editar'; edit.disabled = !can; edit.onclick = ()=>editarPresenca(reg.id);
      const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='üóëÔ∏è Deletar'; del.disabled = !can; del.onclick = ()=>deletarPresenca(reg.id);
      td.appendChild(edit); td.appendChild(del);
    } else {
      const pbtn = document.createElement('button'); pbtn.className='btn btn-ghost'; pbtn.textContent='Marcar Presente'; pbtn.onclick = ()=>{ registrarOuAtualizarPresenca(a.id, diaISO, true); renderPresenca(); };
      const fbtn = document.createElement('button'); fbtn.className='btn btn-ghost'; fbtn.textContent='Marcar Falta'; fbtn.onclick = ()=>{ registrarOuAtualizarPresenca(a.id, diaISO, false); renderPresenca(); };
      td.appendChild(pbtn); td.appendChild(fbtn);
    }
    tr.appendChild(td); tbody.appendChild(tr);
  });

  const table = document.getElementById('presenca-table'), ind = document.getElementById('ld-pres-fechado-ind');
  if(estado.presencaFechadaISO){ if(table) table.classList.add('fechado'); if(ind) ind.textContent = `Fechada em ${new Date(estado.presencaFechadaISO).toLocaleString()}`; }
  else { if(table) table.classList.remove('fechado'); if(ind) ind.textContent = 'Lista aberta'; }

  resumoFrequencia();
}

function editarPresenca(id){ const r = estado.presencas.find(x=>x.id===id); if(!r || !podeEditarPresenca(r)) return alert('Voc√™ n√£o tem permiss√£o para editar.'); const novo = confirm('OK = Presente, Cancelar = Falta'); r.presente = novo; renderPresenca(); renderLiderPresencas(); renderLiderLog(); }
function deletarPresenca(id){ const idx = estado.presencas.findIndex(x=>x.id===id); if(idx<0) return; if(!podeEditarPresenca(estado.presencas[idx])) return alert('Voc√™ n√£o tem permiss√£o para deletar.'); estado.presencas.splice(idx,1); renderPresenca(); renderLiderPresencas(); renderLiderLog(); }

function adicionarIntervalo(tipo){ const wrapId = tipo==='presenca' ? 'filtros-presenca' : 'filtros-oferta'; const wrap = document.getElementById(wrapId); if(!wrap) return; const div = document.createElement('div'); div.className = tipo==='presenca' ? 'intervalo-pres' : 'intervalo-of'; div.innerHTML = `<label>In√≠cio</label><input type="date" class="${tipo==='presenca'?'pres-inicio':'of-inicio'}"><label>Fim</label><input type="date" class="${tipo==='presenca'?'pres-fim':'of-fim'}">`; wrap.appendChild(div); }

function resumoFrequencia(){ const tbody=document.getElementById('resumo-presenca'); if(!tbody) return; tbody.innerHTML=''; const datasSet=new Set(estado.presencas.map(p=>p.dataISO)); const encontros=Array.from(datasSet); estado.alunos.forEach(a=>{ const regs=estado.presencas.filter(p=>p.alunoId===a.id); const presentes=regs.filter(r=>r.presente).length; const faltas=regs.filter(r=>!r.presente).length; const total=encontros.length||1; const pct=Math.round((presentes/total)*100); const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.nome}</td><td>${pct}%</td><td>${presentes}</td><td>${faltas}</td>`; tbody.appendChild(tr); }); }

/* ===========================
   Ofertas
   =========================== */
function canSaidaOferta(){ return estado.papel==='lider'; }

function adicionarOferta(){
  if(!estado.usuario) return alert('Entre como L√≠der ou Auxiliar para registrar.');
  const cat = document.getElementById('of-cat').value;
  const tipo = document.getElementById('of-tipo').value;
  const valor = parseFloat(document.getElementById('of-valor').value||'0');
  const obs = document.getElementById('of-obs').value.trim();
  if(!valor || valor <= 0) return alert('Informe um valor v√°lido.');
  if(cat==='oferta' && tipo==='saida' && !canSaidaOferta()) return alert('Somente l√≠deres podem registrar sa√≠da de oferta.');
  const registrador = estado.usuario?.nome||'Visitante';
  const papel = estado.usuario?.papel||'visitante';
  const item = { id:'of-'+Date.now(), categoria:cat, tipo, valor, obs, criadoEm:new Date().toISOString(), registradoPorNome:registrador, papel };
  estado.ofertas.push(item);
  document.getElementById('of-valor').value=''; document.getElementById('of-obs').value='';
  renderOferta(); renderPainelLider(); renderLiderLog();
}

function renderOferta(){
  const entradas = estado.ofertas.filter(o=>o.categoria==='oferta' && o.tipo==='entrada').reduce((s,o)=>s+o.valor,0);
  const saidas = estado.ofertas.filter(o=>o.categoria==='oferta' && o.tipo==='saida').reduce((s,o)=>s+o.valor,0);
  const saldo = entradas - saidas;
  const elSaldo = document.getElementById('saldo-atual'); if(elSaldo) elSaldo.textContent = moeda(saldo);

  const tbody = document.getElementById('historico-oferta'); if(tbody) tbody.innerHTML='';
  estado.ofertas.slice().reverse().forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(o.criadoEm).toLocaleString()}</td><td>${o.categoria}</td><td>${o.tipo}</td><td>R$ ${o.valor.toFixed(2).replace('.',',')}</td><td>${o.registradoPorNome} (${o.papel})</td><td>${o.obs||''}</td>`;
    const td = document.createElement('td');
    const can = podeEditarOferta(o);
    const edit = document.createElement('button'); edit.className='btn btn-ghost'; edit.textContent='‚úèÔ∏è Editar'; edit.disabled = !can; edit.onclick = ()=>editarOferta(o.id);
    td.appendChild(edit); tr.appendChild(td); tbody.appendChild(tr);
  });

  const elAcum = document.getElementById('saldo-acumulado-oferta'); if(elAcum) elAcum.textContent = moeda(estado.saldoOfertaAcumulado);
}

function editarOferta(id){ const item = estado.ofertas.find(o=>o.id===id); if(!item || !podeEditarOferta(item)) return alert('Voc√™ n√£o tem permiss√£o para editar.'); const nv = prompt('Novo valor (use ponto para centavos):', String(item.valor)); const val = parseFloat(nv); if(!isNaN(val) && val>0){ item.valor = val; renderOferta(); renderPainelLider(); renderLiderLog(); } }

function exportarOfertas(){
  const intervals = Array.from(document.querySelectorAll('#filtros-oferta .intervalo-of')).map(div=>({ ini:div.querySelector('.of-inicio').value, fim:div.querySelector('.of-fim').value })).filter(x=>x.ini&&x.fim);
  const rows = estado.ofertas.filter(o=> intervals.some(i=> o.criadoEm.slice(0,10) >= i.ini && o.criadoEm.slice(0,10) <= i.fim ) ).map(o=>[o.criadoEm,o.categoria,o.tipo,o.valor.toFixed(2).replace('.',','),o.registradoPorNome,o.papel,o.obs||'']);
  baixarCSV('ofertas.csv',['Data','Categoria','Tipo','Valor','Registrado Por','Papel','Obs'], rows);
}

/* ===========================
   Feed
   =========================== */
function postarFeed(){
  const texto = document.getElementById('feed-texto').value.trim();
  const publico = document.getElementById('feed-publico').checked;
  const mencoes = document.getElementById('feed-mencoes').value.split(',').map(s=>s.trim()).filter(Boolean);
  const tipo = document.getElementById('feed-tipo').value;
  if(!texto) return alert('Digite uma mensagem.');
  const autor = estado.usuario?.nome || 'Visitante';
  const item = { id:'fd-'+Date.now(), texto, publico, mencionados:mencoes, tipo, criadoEm:new Date().toISOString(), criadoPorNome:autor, reacoes:{gostei:0,coracao:0,festa:0}, comentarios:[] };
  estado.feed.push(item);
  document.getElementById('feed-texto').value=''; document.getElementById('feed-mencoes').value='';
  renderFeed(); alert('Mensagem postada.');
}

function renderFeed(){
  const ulPapel = document.getElementById('feed-papel'); const ulPub = document.getElementById('feed-publico-lista');
  if(ulPapel) ulPapel.innerHTML=''; if(ulPub) ulPub.innerHTML='';
  const nomeAtual = estado.usuario?.nome?.toLowerCase() || '';
  const papelAtual = estado.papel;
  const feedPapel = estado.feed.filter(item=>{
    if(papelAtual==='lider') return true;
    const mencionado = item.mencionados?.map(m=>m.toLowerCase()).includes(nomeAtual);
    return item.publico || mencionado;
  }).slice().reverse();
  const feedPub = estado.feed.filter(f=>f.publico && f.tipo==='evento').slice().reverse();
  feedPapel.forEach(item=>{ if(ulPapel) ulPapel.appendChild(renderFeedItem(item,true)); });
  feedPub.forEach(item=>{ if(ulPub) ulPub.appendChild(renderFeedItem(item,false)); });
}

function renderFeedItem(item,podeComentar){
  const li = document.createElement('li'); li.className='card';
  const menc = item.mencionados?.length ? `<div class="subtle">Men√ß√µes: ${item.mencionados.join(', ')}</div>` : '';
  li.innerHTML = `<strong>${item.tipo.toUpperCase()}</strong> ‚Ä¢ ${new Date(item.criadoEm).toLocaleString()}<div style="margin-top:8px">${item.texto}</div>${menc}`;
  const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost mt-8'; editBtn.textContent='‚úèÔ∏è Editar'; editBtn.disabled = !podeEditarFeed(item); editBtn.onclick = ()=>editarFeed(item.id);
  li.appendChild(editBtn);
  if(podeComentar){
    const box = document.createElement('div'); box.className='mt-8';
    const input = document.createElement('input'); input.placeholder='Escreva um coment√°rio...';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Comentar'; btn.onclick = ()=>comentar(item.id,input.value);
    box.appendChild(input); box.appendChild(btn); li.appendChild(box);
  }
  if(item.comentarios?.length){ const ul = document.createElement('ul'); item.comentarios.forEach(c=>{ const ci=document.createElement('li'); ci.innerHTML=`<span class="subtle">${c.nome}:</span> ${c.texto}`; ul.appendChild(ci); }); li.appendChild(ul); }
  return li;
}
function reagir(id,tipo){ const f = estado.feed.find(x=>x.id===id); if(!f) return; f.reacoes[tipo] = (f.reacoes[tipo]||0)+1; renderFeed(); }
function comentar(id,texto){ const t = texto.trim(); if(!t) return alert('Escreva algo.'); const f = estado.feed.find(x=>x.id===id); if(!f) return; const nome = estado.usuario?.nome || 'Visitante'; f.comentarios.push({nome,texto:t,aprovado:true}); renderFeed(); }
function editarFeed(id){ const item = estado.feed.find(f=>f.id===id); if(!item||!podeEditarFeed(item)) return alert('Voc√™ n√£o tem permiss√£o para editar.'); const novo = prompt('Novo texto:', item.texto); if(novo){ item.texto = novo; renderFeed(); } }

/* ===========================
   Arquivos
   =========================== */
function enviarArquivo(){ if(!(estado.papel==='lider' || estado.papel==='auxiliar')) return alert('Entre como l√≠der ou auxiliar para enviar arquivos.'); const titulo=document.getElementById('arq-titulo').value.trim(); const tipo=document.getElementById('arq-tipo').value; const fileInput=document.getElementById('arq-file'); if(!titulo || !fileInput.files.length) return alert('Informe t√≠tulo e selecione um arquivo.'); const id='arq-'+Date.now(); estado.arquivos.push({ id, titulo, tipo, url:fileInput.files[0].name, criadoEm:new Date().toISOString() }); document.getElementById('arq-titulo').value=''; fileInput.value=''; renderArquivos(); }
function renderArquivos(){ const lista=document.getElementById('arquivos-lista'); if(!lista) return; lista.innerHTML=''; estado.arquivos.slice().reverse().forEach(a=>{ const li=document.createElement('li'); const link = a.url ? `<a href="#" onclick="alert('Link real vir√° do Storage');return false;">üì• Baixar</a>` : ''; li.innerHTML = `${a.titulo} (${a.tipo.toUpperCase()}) ‚Ä¢ <span class="subtle">${new Date(a.criadoEm).toLocaleString()}</span> ${link}`; lista.appendChild(li); }); }

/* ===========================
   Pais: fichas com campos extras
   =========================== */
function salvarFicha(){
  const nome = document.getElementById('ficha-nome').value.trim();
  const nasc = document.getElementById('ficha-nasc').value;
  const resp = document.getElementById('ficha-resp').value.trim();
  const tel = document.getElementById('ficha-tel').value.trim();
  const endereco = document.getElementById('ficha-endereco').value.trim();
  const telEmerg = document.getElementById('ficha-tel-emergencia').value.trim();
  const contatoEmerg = document.getElementById('ficha-contato-emergencia').value.trim();
  const obs = document.getElementById('ficha-obs').value.trim();
  if(!nome || !nasc || !resp || !tel) return alert('Preencha todos os campos obrigat√≥rios (nome, nascimento, respons√°vel, telefone).');
  estado.fichas.push({ id:'fi-'+Date.now(), nome, nasc, resp, tel, endereco, telEmerg, contatoEmerg, obs, criadoEm:new Date().toISOString() });
  document.getElementById('ficha-nome').value=''; document.getElementById('ficha-nasc').value=''; document.getElementById('ficha-resp').value=''; document.getElementById('ficha-tel').value=''; document.getElementById('ficha-endereco').value=''; document.getElementById('ficha-tel-emergencia').value=''; document.getElementById('ficha-contato-emergencia').value=''; document.getElementById('ficha-obs').value='';
  renderPais(); renderFichasLider(); alert('Ficha salva!');
}

function renderPais(){
  const eventos = document.getElementById('eventosPais');
  if(eventos){
    eventos.innerHTML = '';
    const evs = estado.feed.filter(f=>f.publico && f.tipo==='evento').slice().reverse();
    if(evs.length === 0){
      const li = document.createElement('li'); li.className='subtle'; li.textContent='Nenhum evento por enquanto.'; eventos.appendChild(li);
    } else {
      evs.forEach(ev=>{ const li=document.createElement('li'); li.textContent = `${ev.texto} ‚Ä¢ ${new Date(ev.criadoEm).toLocaleDateString()}`; eventos.appendChild(li); });
    }
  }

  const fichasUL = document.getElementById('fichas-lista'); if(!fichasUL) return; fichasUL.innerHTML='';
  if(estado.fichas.length===0){
    const li = document.createElement('li'); li.className = 'subtle'; li.textContent = 'Nenhuma ficha cadastrada ainda.'; fichasUL.appendChild(li);
    return;
  }
  estado.fichas.slice().reverse().forEach(fi=>{
    const li = document.createElement('li');
    const parts = `<strong>${fi.nome}</strong> ‚Ä¢ nasc: ${fi.nasc} ‚Ä¢ resp: ${fi.resp} ‚Ä¢ tel: ${fi.tel}`;
    const extras = `${fi.endereco ? ' ‚Ä¢ end: '+fi.endereco : ''}${fi.contatoEmerg ? ' ‚Ä¢ contato em: '+fi.contatoEmerg : ''}${fi.telEmerg ? ' ‚Ä¢ tel emerg: '+fi.telEmerg : ''}`;
    li.innerHTML = parts + extras + ` ‚Ä¢ <span class="subtle">${new Date(fi.criadoEm).toLocaleString()}</span>`;
    fichasUL.appendChild(li);
  });
}

function renderFichasLider(){ const ul=document.getElementById('fichas-lider'); if(!ul) return; ul.innerHTML=''; estado.fichas.slice().reverse().forEach(fi=>{ const li=document.createElement('li'); const extras = `${fi.endereco ? ' ‚Ä¢ end: '+fi.endereco : ''}${fi.contatoEmerg ? ' ‚Ä¢ contato em: '+fi.contatoEmerg : ''}${fi.telEmerg ? ' ‚Ä¢ tel emerg: '+fi.telEmerg : ''}`; li.innerHTML = `${fi.nome} ‚Ä¢ nasc: ${fi.nasc} ‚Ä¢ resp: ${fi.resp} ‚Ä¢ tel: ${fi.tel}${extras} ‚Ä¢ <span class="subtle">${new Date(fi.criadoEm).toLocaleString()}</span>`; ul.appendChild(li); }); }

/* ===========================
   Lider: finan√ßas e fechamento
   =========================== */
function separarOfertasMensal(ofertas){ const map=new Map(); ofertas.forEach(o=>{ const key = yyyymm(o.criadoEm); if(!map.has(key)) map.set(key,[]); map.get(key).push(o); }); return map; }
function calcularResumo(ofs){ const entradas = ofs.filter(o=>o.categoria==='oferta' && o.tipo==='entrada').reduce((s,o)=>s+o.valor,0); const saidas = ofs.filter(o=>o.categoria==='oferta' && o.tipo==='saida').reduce((s,o)=>s+o.valor,0); const gastos = ofs.filter(o=>o.categoria==='gasto').reduce((s,o)=>s+o.valor,0); const saldoMes = entradas - saidas; const ultima = ofs.slice().sort((a,b)=>new Date(b.criadoEm)-new Date(a.criadoEm))[0]||null; return { entradas, saidas, gastos, saldoMes, ultima }; }

function renderPainelLider(){
  const total = calcularResumo(estado.ofertas);
  setText('ld-total-entradas', moeda(total.entradas));
  setText('ld-total-saidas', moeda(total.saidas));
  setText('ld-saldo-mes-atual', moeda(total.saldoMes));
  setText('ld-saldo-acumulado', moeda(estado.saldoOfertaAcumulado));
  setText('ld-ultima-mov', total.ultima ? `${new Date(total.ultima.criadoEm).toLocaleString()} ‚Ä¢ ${total.ultima.categoria}/${total.ultima.tipo} ‚Ä¢ ${moeda(total.ultima.valor)}` : '‚Äî');

  const chk = document.getElementById('ld-permitir-edicoes-pos-fech'); if(chk) chk.checked = !!estado.permitirEdicoesPosFechamento;

  renderLiderMes(); renderLiderFecharMesInfo(); renderLiderPresencas(); renderLiderLog();
}

function renderLiderMes(){
  const sel = document.getElementById('ld-mes-select'); if(!sel) return;
  const grupos = separarOfertasMensal(estado.ofertas);
  const chaves = Array.from(grupos.keys()).sort().reverse();
  sel.innerHTML = ''; if(chaves.length===0){ const opt=document.createElement('option'); opt.value=''; opt.textContent='Sem movimenta√ß√µes'; sel.appendChild(opt); setText('ld-mes-entradas',moeda(0)); setText('ld-mes-saidas',moeda(0)); setText('ld-mes-gastos',moeda(0)); setText('ld-mes-saldo',moeda(0)); document.getElementById('ld-mes-historico').innerHTML=''; }
  else { chaves.forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=k; sel.appendChild(opt); }); sel.value=chaves[0]; }
  const k=sel.value; const ofsMes = grupos.get(k)||[]; const r = calcularResumo(ofsMes);
  setText('ld-mes-entradas', moeda(r.entradas)); setText('ld-mes-saidas', moeda(r.saidas)); setText('ld-mes-gastos', moeda(r.gastos)); setText('ld-mes-saldo', moeda(r.saldoMes));
  const tbody=document.getElementById('ld-mes-historico'); if(!tbody) return; tbody.innerHTML=''; ofsMes.slice().sort((a,b)=>new Date(b.criadoEm)-new Date(a.criadoEm)).forEach(o=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(o.criadoEm).toLocaleString()}</td><td>${o.categoria}</td><td>${o.tipo}</td><td>${moeda(o.valor)}</td><td>${o.registradoPorNome} (${o.papel})</td><td>${o.obs||''}</td>`; tbody.appendChild(tr); });
}

function liderFecharMes(){
  if(estado.papel!=='lider') return alert('Apenas o l√≠der pode fechar o m√™s.');
  const resumoAtual = calcularResumo(estado.ofertas);
  const msg = `Resumo do m√™s:\nEntradas: ${moeda(resumoAtual.entradas)}\nSa√≠das: ${moeda(resumoAtual.saidas)}\nGastos pessoais: ${moeda(resumoAtual.gastos)}\nSaldo do m√™s: ${moeda(resumoAtual.saldoMes)}\n\nConfirma fechamento do m√™s?`;
  if(!confirm(msg)) return;
  estado.saldoOfertaAcumulado += resumoAtual.saldoMes;
  estado.ofertas = [];
  estado.ofertaUltimoFechamentoISO = new Date().toISOString();
  renderOferta(); renderPainelLider(); alert(`M√™s fechado. Saldo acumulado: ${moeda(estado.saldoOfertaAcumulado)}.`);
}
function renderLiderFecharMesInfo(){ const span=document.getElementById('ld-fechar-mes-info'); if(!span) return; span.textContent = `√öltimo fechamento: ${estado.ofertaUltimoFechamentoISO ? new Date(estado.ofertaUltimoFechamentoISO).toLocaleString() : '‚Äî'}`; }
function verificarFechamentoAutomatico(){ if(!estado.ofertaUltimoFechamentoISO) return; const ms = new Date() - new Date(estado.ofertaUltimoFechamentoISO); const dias = ms/(1000*60*60*24); if(dias>=30) liderFecharMes(); }

function renderLiderPresencas(){
  const encontrosSet = new Set(estado.presencas.map(p=>p.dataISO));
  setText('ld-pres-encontros', String(encontrosSet.size));
  setText('ld-pres-alunos', String(estado.alunos.filter(a=>a.tipo==='aluno').length));
  setText('ld-pres-convidados', String(estado.alunos.filter(a=>a.tipo==='convidado').length));
  const tbody = document.getElementById('ld-pres-resumo'); if(!tbody) return; tbody.innerHTML='';
  const encontros = Array.from(encontrosSet);
  estado.alunos.forEach(a=>{ const regs = estado.presencas.filter(p=>p.alunoId===a.id); const presentes = regs.filter(r=>r.presente).length; const faltas = regs.filter(r=>!r.presente).length; const total = encontros.length||1; const pct = Math.round((presentes/total)*100); const tr=document.createElement('tr'); tr.innerHTML = `<td>${a.nome}</td><td>${pct}%</td><td>${presentes}</td><td>${faltas}</td>`; tbody.appendChild(tr); });
}

function renderLiderLog(){
  const tbody=document.getElementById('ld-log-body'); if(!tbody) return; const tipoSel=document.getElementById('ld-log-tipo')?.value||'todos'; const ini=document.getElementById('ld-log-inicio')?.value||''; const fim=document.getElementById('ld-log-fim')?.value||'';
  const eventosPres = estado.presencas.map(p=>({ dataISO:p.criadoEm, tipo:'presenca', detalhe:`${p.dataISO} ‚Ä¢ ${p.presente?'Presente':'Falta'} ‚Ä¢ ${estado.alunos.find(a=>a.id===p.alunoId)?.nome||'‚Äî'}`, por:p.registradoPorNome, papel:p.papel }));
  const eventosOf = estado.ofertas.map(o=>({ dataISO:o.criadoEm, tipo:'oferta', detalhe:`${o.categoria}/${o.tipo} ‚Ä¢ ${moeda(o.valor)}${o.obs?(' ‚Ä¢ '+o.obs):''}`, por:o.registradoPorNome, papel:o.papel }));
  let todos = [...eventosPres, ...eventosOf];
  if(tipoSel!=='todos') todos = todos.filter(e=>e.tipo===tipoSel);
  if(ini && fim) todos = todos.filter(e=>{ const d=e.dataISO.slice(0,10); return d>=ini && d<=fim; });
  todos.sort((a,b)=>new Date(b.dataISO)-new Date(a.dataISO));
  tbody.innerHTML=''; todos.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(e.dataISO).toLocaleString()}</td><td>${e.tipo}</td><td>${e.detalhe}</td><td>${e.por}</td><td>${e.papel}</td>`; tbody.appendChild(tr); });
}

/* ===========================
   Fechar lista de presen√ßa
   =========================== */
function fecharListaPresenca(){
  if(estado.papel !== 'lider') return alert('Apenas o l√≠der pode fechar a lista de presen√ßa.');
  if(estado.presencaFechadaISO) return alert('A lista j√° est√° fechada.');
  const datasSet = new Set(estado.presencas.map(p=>p.dataISO)); const encontros = Array.from(datasSet);
  if(encontros.length===0) return alert('N√£o h√° registros para fechar.');
  let resumo = 'Resumo de frequ√™ncia por aluno:\n\n';
  estado.alunos.forEach(a=>{ const regs = estado.presencas.filter(p=>p.alunoId===a.id); const presentes = regs.filter(r=>r.presente).length; const faltas = regs.filter(r=>!r.presente).length; const total = encontros.length||1; const pct = Math.round((presentes/total)*100); resumo += `${a.nome}: ${pct}% ‚Ä¢ Presente: ${presentes} ‚Ä¢ Falta: ${faltas}\n`; });
  if(!confirm(`Voc√™ vai FECHAR a lista de presen√ßa. Isso bloquear√° edi√ß√µes de presen√ßa para auxiliares (a menos que o l√≠der permita depois).\n\n${resumo}\nConfirmar fechamento?`)) return;
  estado.presencaFechadaISO = new Date().toISOString();
  renderPresenca(); renderLiderPresencas(); alert('Lista de presen√ßa fechada.');
}

/* ===========================
   Toggle: permitir edi√ß√µes p√≥s-fechamento
   =========================== */
function togglePermitirEdicoes(){
  if(estado.papel!=='lider'){ document.getElementById('ld-permitir-edicoes-pos-fech').checked = !!estado.permitirEdicoesPosFechamento; return alert('Apenas o l√≠der pode alterar isso.'); }
  estado.permitirEdicoesPosFechamento = !estado.permitirEdicoesPosFechamento;
  renderPresenca(); renderOferta(); renderPainelLider();
  alert(`Permitir edi√ß√µes p√≥s-fechamento: ${estado.permitirEdicoesPosFechamento ? 'Ativado' : 'Desativado'}`);
}

/* ===========================
   Inicializa√ß√£o
   =========================== */
document.addEventListener('change',(e)=>{ if(e.target && (['ld-log-tipo','ld-log-inicio','ld-log-fim','ld-mes-select'].includes(e.target.id))){ renderLiderLog(); renderLiderMes(); } });
(function init(){ estado.papel='visitante'; // garantir ordem alfab√©tica dos alunos por seguran√ßa
  estado.alunos.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
  renderPais(); renderFeed(); })();
</script>

</body>
</html>
